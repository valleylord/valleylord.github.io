
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Java class文件解析代码分析 | 褚哥说|</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Valleylord">
    
    <meta name="description" content="每一个Java类在经过编译后，都会生成.class文件，作为JVM执行的输入。.class文件的结构分析和示例可以参考1，2，3。本文用Java代码分析.class文件的结构，获取类的定义，以及类中每一个域和方法的声明。
首先，.class文件是Java的字节码文件，需要逐个逐个字节的读入，因此需要">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="褚哥说|" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/author.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/monokai.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="褚哥说|">褚哥说|</a></h1>
				<h2 class="blog-motto">我想写一些东西</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul><li> <a href="/atom.xml">RSS</a> </li>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/tags">标签</a></li>
					
						<li><a href="/links">链接</a></li>
					
						<li><a href="http://www.cnblogs.com/valleylord/">旧文</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div></li>

				</ul>
			</nav>
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/post/201410-java-class-file/" title="Java class文件解析代码分析" itemprop="url">Java class文件解析代码分析</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://valleylord.github.io" title="Valleylord">Valleylord</a>
    </p>
  <p class="article-time">
    <time datetime="2014-10-18T04:38:00.000Z" itemprop="datePublished">2014-10-18</time>
    更新日期:<time datetime="2016-05-25T15:04:52.865Z" itemprop="dateModified">2016-05-25</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
		</div>
		
		<p>每一个Java类在经过编译后，都会生成.class文件，作为JVM执行的输入。.class文件的结构分析和示例可以参考<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>，<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>，<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>。本文用Java代码分析.class文件的结构，获取类的定义，以及类中每一个域和方法的声明。</p>
<p>首先，.class文件是Java的字节码文件，需要逐个逐个字节的读入，因此需要一个读入文件的类，我对<code>DataInputStream</code>做一些简单封装，得到读入.class文件的类，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.DataInputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="comment">/* Class file reader wrapper</span></div><div class="line"> * Simple wrapper for DataInputStream</div><div class="line"> *</div><div class="line"> * u4 and u8 has problem when reading float and double</div><div class="line"> * but we do not use the value info of them</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassReader</span> </span>{</div><div class="line">	DataInputStream input;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="title">ClassReader</span>(DataInputStream input) {</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.input = input;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// read 1 byte</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">u1</span>() <span class="keyword">throws</span> IOException {</div><div class="line">		<span class="keyword">return</span> input.readByte();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// read 2 byte as short</span></div><div class="line">	<span class="keyword">public</span> Short <span class="title">u2</span>() <span class="keyword">throws</span> IOException {</div><div class="line">		<span class="keyword">return</span> input.readShort();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// read 4 byte as int, cannot read float</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">u4</span>() <span class="keyword">throws</span> IOException {</div><div class="line">		<span class="keyword">return</span> input.readInt();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// read 8 byte as long, cannot read double</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">long</span> <span class="title">u8</span>() <span class="keyword">throws</span> IOException {</div><div class="line">		<span class="keyword">return</span> input.readLong();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// wrapper for DataInputStream.readByte</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">readByte</span>() <span class="keyword">throws</span> IOException{</div><div class="line">		<span class="keyword">return</span> input.readByte();</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// wrapper for DataInputStream.readFully</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFully</span>(<span class="keyword">byte</span>[] b) <span class="keyword">throws</span> IOException {</div><div class="line">		input.readFully(b);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">// wrapper for DataInputStream.close</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span>() <span class="keyword">throws</span> IOException{</div><div class="line">		input.close();</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>有了这个类，就可以使用<code>int magic = input.u4();</code>类似这样的代码来读入.class文件中4个byte的内容，并转换为<code>int</code>。还需要表示常量池内元素的类和常量池类，由于常量池内的元素种类比较多，所以对不同的种类要有不同的类来表示。所以，设计常量种类的枚举类型<code>EnumConstType</code>，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1;</div><div class="line"></div><div class="line"><span class="comment">/* constant elem type</span></div><div class="line"> * tested under jdk 1.6.0_45</div><div class="line"> *</div><div class="line">CONSTANT_Utf8	1	UTF-8编码的Unicode字符串</div><div class="line">CONSTANT_Integer	3	int类型的字面值</div><div class="line">CONSTANT_Float	4	float类型的字面值</div><div class="line">CONSTANT_Long	5	long类型的字面值</div><div class="line">CONSTANT_Double	6	double类型的字面值</div><div class="line">CONSTANT_Class	7	对一个类或接口的符号引用</div><div class="line">CONSTANT_String	8	String类型字面值的引用</div><div class="line">CONSTANT_Fieldref	9	对一个字段的符号引用</div><div class="line">CONSTANT_Methodref	10	对一个类中方法的符号引用</div><div class="line">CONSTANT_InterfaceMethodref	11	对一个接口中方法的符号引用</div><div class="line">CONSTANT_NameAndType	12	对一个字段或方法的部分符号引用</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EnumConstType {</div><div class="line">	<span class="comment">// Enumerate each constant type for jdk 1.6</span></div><div class="line">	C_UTF8,    <span class="comment">//(1),</span></div><div class="line">	C_INTEGER, <span class="comment">//(3),</span></div><div class="line">	C_FLOAT,   <span class="comment">//(4),</span></div><div class="line">	C_LONG,    <span class="comment">//(5),</span></div><div class="line">	C_DOUBLE,  <span class="comment">//(6),</span></div><div class="line">	C_CLASS,   <span class="comment">//(7),</span></div><div class="line">	C_STRING,  <span class="comment">//(8),</span></div><div class="line">	C_FIELDREF,<span class="comment">//(9),</span></div><div class="line">	C_METHODREF,<span class="comment">//(10),</span></div><div class="line">	C_INTERFACEMETHODREF,<span class="comment">//(11),</span></div><div class="line">	C_NAMEANDTYPE;<span class="comment">//(12);</span></div><div class="line"></div><div class="line">	<span class="comment">/* generate EnumConstType from int read from class file</span></div><div class="line">	 */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EnumConstType <span class="title">generateByValue</span>(<span class="keyword">int</span> value){</div><div class="line">    	<span class="keyword">switch</span> (value){</div><div class="line">    	<span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_UTF8"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_INTEGER"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_FLOAT"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">5</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_LONG"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">6</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_DOUBLE"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">7</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_CLASS"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">8</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_STRING"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">9</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_FIELDREF"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">10</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_METHODREF"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">11</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_INTERFACEMETHODREF"</span>);</div><div class="line">    	<span class="keyword">case</span> <span class="number">12</span>: <span class="keyword">return</span> EnumConstType.valueOf(<span class="string">"C_NAMEANDTYPE"</span>);</div><div class="line">    	<span class="keyword">default</span>: <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    	}</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>此外，常量池内元素通用的元素都包括表示常量种类的<code>tag</code>，和常量在常量池中的索引编号<code>index</code>，因此，提取这两个域设计常量元素的超类<code>ConstElem</code>，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* super class for constant elem</span></div><div class="line"> * all constant elem class should extends this class</div><div class="line"> */</div><div class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	EnumConstType tag;  <span class="comment">// constant type</span></div><div class="line">	<span class="keyword">int</span> index;          <span class="comment">// index in constant pool</span></div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="title">ConstElem</span>(EnumConstType tag, <span class="keyword">int</span> index) {</div><div class="line">		<span class="keyword">super</span>();</div><div class="line">		<span class="keyword">this</span>.tag = tag;</div><div class="line">		<span class="keyword">this</span>.index = index;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> EnumConstType <span class="title">getTag</span>() {</div><div class="line">		<span class="keyword">return</span> tag;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTag</span>(EnumConstType tag) {</div><div class="line">		<span class="keyword">this</span>.tag = tag;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span>() {</div><div class="line">		<span class="keyword">return</span> index;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex</span>(<span class="keyword">int</span> index) {</div><div class="line">		<span class="keyword">this</span>.index = index;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>对于jdk1.6的情况，可以将常量池元素的类别，<code>EnumConstType</code>中的不同类别结构，分成5类。类别1：CONSTANT_Utf8，包含1个字符串；类别2：CONSTANT_Integer, CONSTANT_Float，包含1个4 byte的数据；类别3：CONSTANT_Long, CONSTANT_Double，包含1个8 byte的数据；类别4：CONSTANT_Class, CONSTANT_String，包含1个2 byte的数据；类别5：CONSTANT_Fieldref, CONSTANT_Methodref, CONSTANT_NameAndType, CONSTANT_InterfaceMethodref，包含2个2 byte的数据。如果是jdk之后的版本，如jdk1.7，还包括MethodHandle, MethodType, InvokeDynamic, 分别取值为15, 16, 18的常量类别，不过在此不做考虑。根据以上5个类别设计的类，分别如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Element for UTF8</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElemU</span> <span class="keyword">extends</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	<span class="comment">/* the text content for utf8 constant</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> String utf8;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ConstElemU</span>(EnumConstType tag, <span class="keyword">int</span> index, String utf8) {</div><div class="line">		<span class="keyword">super</span>(tag, index);</div><div class="line">		<span class="keyword">this</span>.utf8 = utf8;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> String <span class="title">getUtf8</span>() {</div><div class="line">		<span class="keyword">return</span> utf8;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUtf8</span>(String utf8) {</div><div class="line">		<span class="keyword">this</span>.utf8 = utf8;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Element for int and float</span></div><div class="line"> * (not used)</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElemIF</span> <span class="keyword">extends</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> vint;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ConstElemIF</span>(EnumConstType tag, <span class="keyword">int</span> index, <span class="keyword">int</span> vint) {</div><div class="line">		<span class="keyword">super</span>(tag, index);</div><div class="line">        <span class="keyword">this</span>.vint = vint;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVint</span>() {</div><div class="line">		<span class="keyword">return</span> vint;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVint</span>(<span class="keyword">int</span> vint) {</div><div class="line">		<span class="keyword">this</span>.vint = vint;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Element for long and double</span></div><div class="line"> * (not used)</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElemLD</span> <span class="keyword">extends</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	<span class="keyword">private</span> <span class="keyword">long</span> vlong;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ConstElemLD</span>(EnumConstType tag, <span class="keyword">int</span> index, <span class="keyword">long</span> vlong) {</div><div class="line">		<span class="keyword">super</span>(tag, index);</div><div class="line">        <span class="keyword">this</span>.vlong = vlong;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getVlong</span>() {</div><div class="line">		<span class="keyword">return</span> vlong;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVlong</span>(<span class="keyword">long</span> vlong) {</div><div class="line">		<span class="keyword">this</span>.vlong = vlong;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Element for class and string</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElemCS</span> <span class="keyword">extends</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	<span class="comment">/* for Class, point to class name</span></div><div class="line">	 * for String, point to string content</div><div class="line">	 */</div><div class="line">    <span class="keyword">short</span> name;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="title">ConstElemCS</span>(EnumConstType tag, <span class="keyword">int</span> index, <span class="keyword">short</span> name) {</div><div class="line">		<span class="keyword">super</span>(tag, index);</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getName</span>() {</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span>(<span class="keyword">short</span> name) {</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1.constelem;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.EnumConstType;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Element for Fieldref, Methodref,</span></div><div class="line"> * InterfaceMethodref, and NameandType</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstElemFMIN</span> <span class="keyword">extends</span> <span class="title">ConstElem</span> </span>{</div><div class="line">	<span class="comment">/* for Fieldref, Methodref, InterfaceMethodref, point to class info</span></div><div class="line">	 * for NameandType, point to name</div><div class="line">	 */</div><div class="line">    <span class="keyword">short</span> index1;</div><div class="line">	<span class="comment">/* for Fieldref, Methodref, InterfaceMethodref, point to NameandType info</span></div><div class="line">	 * for NameandType, point to descriptor</div><div class="line">	 */</div><div class="line">    <span class="keyword">short</span> index2;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ConstElemFMIN</span>(EnumConstType tag, <span class="keyword">int</span> index, <span class="keyword">short</span> index1, <span class="keyword">short</span> index2) {</div><div class="line">		<span class="keyword">super</span>(tag, index);</div><div class="line">		<span class="keyword">this</span>.index1 = index1;</div><div class="line">		<span class="keyword">this</span>.index2 = index2;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getIndex1</span>() {</div><div class="line">		<span class="keyword">return</span> index1;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex1</span>(<span class="keyword">short</span> index1) {</div><div class="line">		<span class="keyword">this</span>.index1 = index1;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">short</span> <span class="title">getIndex2</span>() {</div><div class="line">		<span class="keyword">return</span> index2;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex2</span>(<span class="keyword">short</span> index2) {</div><div class="line">		<span class="keyword">this</span>.index2 = index2;</div><div class="line">	}</div><div class="line"></div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>由于，本例中没有使用到float和double值的操作，所以读取这部分的数据只是简单的存成整型，实际上，值是有错误的，不过并不影响最后的结果。有了以上这些基础类了之后，就可以在这些基础上，完成常量池类的构建，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.constelem.*;</div><div class="line"></div><div class="line"><span class="comment">/* Constant Pools</span></div><div class="line"> * Use a List to store Constant Pool data in class file</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantPool</span> </span>{</div><div class="line">	<span class="comment">// a list to keep each constant elem</span></div><div class="line">	<span class="keyword">public</span> List&lt;ConstElem&gt; constPool = <span class="keyword">new</span> ArrayList&lt;ConstElem&gt;(<span class="number">1024</span>);</div><div class="line"></div><div class="line">	<span class="comment">/* append an element in constant pool</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span>(ConstElem a){</div><div class="line">		<span class="keyword">return</span> constPool.add(a);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get element for ConstElem.index = index</span></div><div class="line">	 * paras: index, index in class file, starts from 1</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> ConstElem <span class="title">getElemAt</span>(<span class="keyword">int</span> index){</div><div class="line">		ConstElem e = constPool.get(index-<span class="number">1</span>);</div><div class="line">		<span class="keyword">if</span> (e.getIndex() == index){</div><div class="line">			<span class="keyword">return</span> e;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (ConstElem e1:constPool){</div><div class="line">			<span class="keyword">if</span>(e1.getIndex() == index){</div><div class="line">				<span class="keyword">return</span> e1;</div><div class="line">			}</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* read an elem from constant pool</span></div><div class="line">	 * paras: input, ClassReader wrapper for class file</div><div class="line">	 *        index, index of elem in constant pool, starts from 1</div><div class="line">	 * return: type of elem</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> EnumConstType <span class="title">analyzeConstant</span>(ClassReader input, <span class="keyword">int</span> index)</div><div class="line">			<span class="keyword">throws</span> IOException {</div><div class="line">		<span class="keyword">short</span> n16, n16_1;</div><div class="line">		<span class="keyword">int</span> n32;</div><div class="line">		<span class="keyword">long</span> n64;</div><div class="line">		<span class="keyword">float</span> f;</div><div class="line">		<span class="keyword">double</span> d;</div><div class="line">		<span class="keyword">byte</span>[] buffer;</div><div class="line">		<span class="keyword">byte</span> tag = input.readByte(); <span class="comment">// read constant tag</span></div><div class="line">		EnumConstType ctag = EnumConstType.generateByValue((<span class="keyword">int</span>)tag);</div><div class="line">		<span class="keyword">switch</span> (ctag) {</div><div class="line">		<span class="keyword">case</span> C_UTF8: <span class="comment">// utf-8 string</span></div><div class="line">			n16 = input.u2();</div><div class="line">			buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[n16];</div><div class="line">			input.readFully(buffer); <span class="comment">// read until buffer is full</span></div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemU(ctag, index, <span class="keyword">new</span> String(buffer)));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_INTEGER: <span class="comment">// integer</span></div><div class="line">			n32 = input.u4();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemIF(ctag, index, n32));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_FLOAT: <span class="comment">// float</span></div><div class="line">			f = input.u4();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemIF(ctag, index, (<span class="keyword">int</span>)f));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_LONG: <span class="comment">// long</span></div><div class="line">			n64 = input.u8();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemLD(ctag, index, n64));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_DOUBLE: <span class="comment">// double</span></div><div class="line">			d = input.u8();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemLD(ctag, index, (<span class="keyword">long</span>)d));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_CLASS: <span class="comment">// class or interface reference</span></div><div class="line">			n16 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemCS(ctag, index, n16));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_STRING: <span class="comment">// string</span></div><div class="line">			n16 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemCS(ctag, index, n16));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_FIELDREF: <span class="comment">// field reference</span></div><div class="line">			n16 = input.u2();</div><div class="line">			n16_1 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemFMIN(ctag, index, n16, n16_1));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_METHODREF: <span class="comment">// method reference</span></div><div class="line">			n16 = input.u2();</div><div class="line">			n16_1 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemFMIN(ctag, index, n16, n16_1));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_INTERFACEMETHODREF: <span class="comment">// interface method reference</span></div><div class="line">			n16 = input.u2();</div><div class="line">			n16_1 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemFMIN(ctag, index, n16, n16_1));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> C_NAMEANDTYPE: <span class="comment">// name and type reference</span></div><div class="line">			n16 = input.u2();</div><div class="line">			n16_1 = input.u2();</div><div class="line">			constPool.add(<span class="keyword">new</span> ConstElemFMIN(ctag, index, n16, n16_1));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Invalid constant pool flag: "</span> + tag);</div><div class="line">		} <span class="comment">// end switch</span></div><div class="line"></div><div class="line">		<span class="keyword">return</span> ctag;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* print the list of constant pool</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printConstPool</span>(){</div><div class="line">		ConstElemU u1;</div><div class="line">		ConstElemIF if1;</div><div class="line">		ConstElemLD ld1;</div><div class="line">		ConstElemCS cs1;</div><div class="line">		ConstElemFMIN fmin1;</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"\n[ Constant Pool Info ]:"</span>);</div><div class="line">		<span class="keyword">for</span> (ConstElem e:constPool){</div><div class="line">			System.out.println(<span class="string">"constant index = "</span> + e.getIndex() + <span class="string">", tag = "</span> + e.getTag());</div><div class="line">			<span class="keyword">switch</span>(e.getTag()){</div><div class="line">			<span class="keyword">case</span> C_UTF8:</div><div class="line">				u1 = (ConstElemU)e;</div><div class="line">				System.out.println(<span class="string">"  length = "</span> + u1.getUtf8().length() + <span class="string">" value = "</span> + u1.getUtf8());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> C_INTEGER:  <span class="comment">// INTENTIALLY left blank, same for following</span></div><div class="line">			<span class="keyword">case</span> C_FLOAT:</div><div class="line">				if1 = (ConstElemIF)e;</div><div class="line">				System.out.println(<span class="string">"  value = "</span> + if1.getVint());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> C_LONG:</div><div class="line">			<span class="keyword">case</span> C_DOUBLE:</div><div class="line">				ld1 = (ConstElemLD)e;</div><div class="line">				System.out.println(<span class="string">"  value = "</span> + ld1.getVlong());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> C_CLASS:</div><div class="line">			<span class="keyword">case</span> C_STRING:</div><div class="line">				cs1 = (ConstElemCS)e;</div><div class="line">				System.out.println(<span class="string">"  name at "</span> + cs1.getName());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> C_FIELDREF:</div><div class="line">			<span class="keyword">case</span> C_METHODREF:</div><div class="line">			<span class="keyword">case</span> C_INTERFACEMETHODREF:</div><div class="line">				fmin1 = (ConstElemFMIN)e;</div><div class="line">				System.out.println(<span class="string">"  classindex = "</span> + fmin1.getIndex1()</div><div class="line">						+ <span class="string">" nameandtype = "</span> + fmin1.getIndex2());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> C_NAMEANDTYPE:</div><div class="line">				fmin1 = (ConstElemFMIN)e;</div><div class="line">				System.out.println(<span class="string">"  nameindex = "</span> + fmin1.getIndex1()</div><div class="line">						+ <span class="string">" descriptor = "</span> + fmin1.getIndex2());</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">			;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>对每一个读入的常量，调用<code>analyzeConstant</code>来将其添加到常量池中。有了这个类之后，在分析域和方法的时候，就可以根据域和方法中表示NameandType的索引找到它们的名称和类型。为了能方便的获取到这些名称和类型，设计一个工具类，来产生这些名称和类型的字符串表示，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> problem1.constelem.ConstElemCS;</div><div class="line"><span class="keyword">import</span> problem1.constelem.ConstElemU;</div><div class="line"></div><div class="line"><span class="comment">/* Analyze utilities</span></div><div class="line"> * to get the string representation of</div><div class="line"> * class, fields, methods, and access flags for them</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyzeUtil</span> </span>{</div><div class="line">	<span class="comment">/* get name of Class, super class, and interfaces</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getClassName</span>(ConstantPool cp, <span class="keyword">int</span> index){</div><div class="line">		<span class="keyword">try</span>{</div><div class="line">			ConstElemCS e = (ConstElemCS)cp.getElemAt(index);</div><div class="line">			ConstElemU  u = (ConstElemU)cp.getElemAt(e.getName());</div><div class="line">			<span class="keyword">return</span> u.getUtf8();</div><div class="line">		}<span class="keyword">catch</span>(Exception e){</div><div class="line">			e.printStackTrace();</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get normal representation of a method</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMethodString</span>(ConstantPool cp, <span class="keyword">int</span> idx, <span class="keyword">int</span> idesc){</div><div class="line">		ConstElemU  uName = (ConstElemU)cp.getElemAt(idx);</div><div class="line">		ConstElemU  uDesc = (ConstElemU)cp.getElemAt(idesc);</div><div class="line">		<span class="keyword">return</span> analyzeMethodRet(uDesc.getUtf8()) + <span class="string">" "</span></div><div class="line">			   + uName.getUtf8()</div><div class="line">			   + analyzeMethodParas(uDesc.getUtf8());</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get normal representation of a single type</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">analyzeType</span>(String t){</div><div class="line">		<span class="keyword">switch</span>(t.charAt(<span class="number">0</span>)){</div><div class="line">		<span class="keyword">case</span> <span class="string">'B'</span>: <span class="keyword">return</span> <span class="string">"byte"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'C'</span>: <span class="keyword">return</span> <span class="string">"char"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'D'</span>: <span class="keyword">return</span> <span class="string">"double"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'F'</span>: <span class="keyword">return</span> <span class="string">"float"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'I'</span>: <span class="keyword">return</span> <span class="string">"int"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'J'</span>: <span class="keyword">return</span> <span class="string">"long"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'S'</span>: <span class="keyword">return</span> <span class="string">"short"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'Z'</span>: <span class="keyword">return</span> <span class="string">"boolean"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'V'</span>: <span class="keyword">return</span> <span class="string">"void"</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'L'</span>: <span class="keyword">return</span> t.substring(<span class="number">1</span>, t.indexOf(<span class="string">';'</span>, <span class="number">1</span>));</div><div class="line">		<span class="keyword">case</span> <span class="string">'['</span>: <span class="keyword">return</span> analyzeType(t.substring(<span class="number">1</span>)) + <span class="string">"[]"</span>;</div><div class="line">		<span class="keyword">default</span>:  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		}</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get normal representation of a method's return type</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">analyzeMethodRet</span>(String t){</div><div class="line">		String ret = t.substring(t.indexOf(<span class="string">')'</span>)+<span class="number">1</span>);</div><div class="line">		<span class="keyword">return</span> analyzeType(ret);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get normal representation of a method's parameter type</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">analyzeMethodParas</span>(String t){</div><div class="line">		String paras = t.substring(t.indexOf(<span class="string">'('</span>)+<span class="number">1</span>, t.indexOf(<span class="string">')'</span>));</div><div class="line">		String s = <span class="string">""</span>;</div><div class="line">		<span class="keyword">while</span> (!paras.isEmpty()){</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (i&lt;paras.length()){</div><div class="line">				<span class="keyword">if</span> (paras.charAt(i) == <span class="string">'['</span>) {</div><div class="line">					++i;</div><div class="line">					<span class="keyword">continue</span>;</div><div class="line">				}</div><div class="line">				<span class="keyword">if</span> (paras.charAt(i) == <span class="string">'L'</span>) {</div><div class="line">					String para1 = paras.substring(<span class="number">0</span>, paras.indexOf(<span class="string">';'</span>)+<span class="number">1</span>);</div><div class="line">					s = s + analyzeType(para1) + <span class="string">", "</span>;</div><div class="line">					paras = paras.substring(paras.indexOf(<span class="string">';'</span>)+<span class="number">1</span>);</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				}</div><div class="line">				s = s + analyzeType(paras.substring(<span class="number">0</span>, i+<span class="number">1</span>)) +<span class="string">", "</span>;</div><div class="line">				paras = paras.substring(<span class="number">1</span>);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (s != <span class="string">""</span>){</div><div class="line">			s = s.substring(<span class="number">0</span>, s.length()-<span class="number">2</span>);</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> <span class="string">"("</span> + s + <span class="string">")"</span>;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get name and description of field</span></div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFieldString</span>(ConstantPool cp, <span class="keyword">int</span> in, <span class="keyword">int</span> id){</div><div class="line">		<span class="keyword">try</span>{</div><div class="line">			ConstElemU  uName = (ConstElemU)cp.getElemAt(in);</div><div class="line">			ConstElemU  uDesc = (ConstElemU)cp.getElemAt(id);</div><div class="line">			<span class="keyword">return</span> analyzeType(uDesc.getUtf8())+<span class="string">" "</span>+uName.getUtf8();</div><div class="line">		}<span class="keyword">catch</span>(Exception e){</div><div class="line">			e.printStackTrace();</div><div class="line">		}</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get the String representation of class access flags</span></div><div class="line">	 *</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">analyzeClassAF</span>(<span class="keyword">short</span> access_flags){</div><div class="line">		<span class="keyword">int</span>[] access = { <span class="number">0x0001</span>, <span class="number">0x0010</span>, <span class="number">0x0020</span>, <span class="number">0x0200</span>,</div><div class="line">						<span class="number">0x0400</span>, <span class="number">0x1000</span>, <span class="number">0x2000</span>, <span class="number">0x4000</span>};</div><div class="line">		String[] access_str = { <span class="string">"public"</span>, <span class="string">"final"</span>, <span class="string">"super"</span>, <span class="string">"interface"</span>,</div><div class="line">								<span class="string">"abstract"</span>, <span class="string">"synthetic"</span>, <span class="string">"annotation"</span>, <span class="string">"enum"</span> };</div><div class="line">		<span class="keyword">return</span> analyzeAF(access_flags, access, access_str);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get the String representation of field access flags</span></div><div class="line">	 *</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">analyzeFieldAF</span>(<span class="keyword">short</span> access_flags){</div><div class="line">		<span class="keyword">int</span>[] access = { <span class="number">0x0001</span>, <span class="number">0x0002</span>, <span class="number">0x0004</span>, <span class="number">0x0008</span>,</div><div class="line">				        <span class="number">0x0010</span>, <span class="number">0x0040</span>, <span class="number">0x0080</span>,</div><div class="line">				        <span class="number">0x1000</span>, <span class="number">0x4000</span>};</div><div class="line">		String[] access_str = { <span class="string">"public"</span>, <span class="string">"private"</span>, <span class="string">"protected"</span>, <span class="string">"static"</span>,</div><div class="line">				                <span class="string">"final"</span>, <span class="string">"volatile"</span>, <span class="string">"transient"</span>,</div><div class="line">				                <span class="string">"synthetic"</span>, <span class="string">"enum"</span> };</div><div class="line">		<span class="keyword">return</span> analyzeAF(access_flags, access, access_str);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get the String representation of method access flags</span></div><div class="line">	 *</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">analyzeMethodAF</span>(<span class="keyword">short</span> access_flags){</div><div class="line">		<span class="keyword">int</span>[] access = { <span class="number">0x0001</span>, <span class="number">0x0002</span>, <span class="number">0x0004</span>, <span class="number">0x0008</span>,</div><div class="line">				        <span class="number">0x0010</span>, <span class="number">0x0020</span>, <span class="number">0x0040</span>, <span class="number">0x0080</span>,</div><div class="line">				        <span class="number">0x0100</span>, <span class="number">0x0400</span>, <span class="number">0x0800</span>,</div><div class="line">				        <span class="number">0x1000</span>};</div><div class="line">		String[] access_str = { <span class="string">"public"</span>, <span class="string">"private"</span>, <span class="string">"protected"</span>, <span class="string">"static"</span>,</div><div class="line">				                <span class="string">"final"</span>, <span class="string">"synchronized"</span>, <span class="string">"bridge"</span>, <span class="string">"varargs"</span>,</div><div class="line">				                <span class="string">"native"</span>, <span class="string">"abstract"</span>, <span class="string">"strctfp"</span>,</div><div class="line">				                <span class="string">"synthetic"</span> };</div><div class="line">		<span class="keyword">return</span> analyzeAF(access_flags, access, access_str);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="comment">/* get the String representation of access flags</span></div><div class="line">	 * general form of access flags for class, fields, and methods</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">analyzeAF</span>(<span class="keyword">short</span> access_flags, <span class="keyword">int</span>[] access,</div><div class="line">			String[] access_str){</div><div class="line">		String access_tmp = <span class="string">""</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; access.length; i++) {</div><div class="line">			<span class="keyword">if</span> ((access_flags & access[i]) == access[i]) {</div><div class="line">				<span class="keyword">if</span> (i == <span class="number">0</span>)</div><div class="line">					access_tmp += access_str[i];</div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (i != <span class="number">2</span>)</div><div class="line">					access_tmp += <span class="string">" "</span> + access_str[i];</div><div class="line">			}</div><div class="line">		}</div><div class="line">        <span class="keyword">return</span> access_tmp;</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>以上代码，多数都是解析字符串并转换为可以理解的Java代码的形式、其中，<code>public</code>的方法，如<code>getXXXX</code>方法，可以获取类名称，以及域和方法的字符串表示；<code>analyzeXXXXAF</code>方法，可以获取类，域，方法的访问权限。<code>private</code>的方法，如<code>analyzeXXXX</code>方法，都是公有方法中调用到的其他方法。有了以上这些代码之后，分析class文件就很简单了，如下，</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> problem1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</div><div class="line"><span class="keyword">import</span> java.io.DataInputStream;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassAnalyzer</span> </span>{</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> ConstantPool constPool = <span class="keyword">new</span> ConstantPool();</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String dir = <span class="string">"bin/problem1/constelem/"</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String myClass = dir + <span class="string">"ConstElemU.class"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">		ClassReader input = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> {</div><div class="line">			<span class="comment">// open class file</span></div><div class="line">			input = <span class="keyword">new</span> ClassReader(</div><div class="line">					<span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(</div><div class="line">					<span class="keyword">new</span> FileInputStream(myClass))));</div><div class="line">			<span class="comment">// analyze class file</span></div><div class="line">			analyze(input);</div><div class="line">		} <span class="keyword">catch</span> (Exception e) {</div><div class="line">			System.out.println(<span class="string">"fail to analyze!"</span>);</div><div class="line">			e.printStackTrace();</div><div class="line">		} <span class="keyword">finally</span> {</div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				input.close();</div><div class="line">				<span class="comment">//dataout.close();</span></div><div class="line">			} <span class="keyword">catch</span> (Exception e) {</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printLog</span>(String str){</div><div class="line">		System.out.println(str);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">analyze</span>(ClassReader input) <span class="keyword">throws</span> IOException {</div><div class="line">		<span class="comment">// read magic number</span></div><div class="line">		<span class="keyword">int</span> magic = input.u4();</div><div class="line">		<span class="keyword">if</span> (magic == <span class="number">0xCAFEBABE</span>){</div><div class="line">			printLog(<span class="string">"[ General Info ]:"</span>);</div><div class="line">			printLog(<span class="string">"magic number = 0xCAFEBABE"</span>);</div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"unknown magic number！"</span>);</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="comment">// read major version and minor version</span></div><div class="line">		<span class="keyword">int</span> minor_ver = input.u2();</div><div class="line">		<span class="keyword">int</span> major_ver = input.u2();</div><div class="line">		printLog(<span class="string">"Version = "</span> + major_ver + <span class="string">"."</span> + minor_ver);</div><div class="line"></div><div class="line">		<span class="comment">// read number of constant</span></div><div class="line">		<span class="keyword">short</span> const_pool_count = input.u2();</div><div class="line">		printLog(<span class="string">"constant pool size = "</span> + const_pool_count);</div><div class="line">        <span class="comment">// read each constant in constant pool</span></div><div class="line">		EnumConstType tp = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; const_pool_count; ++i){</div><div class="line">			 tp = constPool.analyzeConstant(input, i); <span class="comment">// analyze each constant</span></div><div class="line"></div><div class="line">			 <span class="comment">// for long and double, they use 2 constant index</span></div><div class="line">			 <span class="keyword">if</span> (tp == EnumConstType.C_LONG || tp == EnumConstType.C_DOUBLE){</div><div class="line">				 ++i;</div><div class="line">			 }</div><div class="line">		}</div><div class="line">		<span class="comment">// print Constant Pool when needed</span></div><div class="line">		constPool.printConstPool();</div><div class="line"></div><div class="line">		<span class="comment">// read access flags for class</span></div><div class="line">		<span class="keyword">short</span> access_flags = input.u2();</div><div class="line">		<span class="comment">// read class, and super class</span></div><div class="line">		<span class="keyword">short</span> this_class_index = input.u2();</div><div class="line">		<span class="keyword">short</span> super_class_index = input.u2();</div><div class="line">		<span class="comment">// print class, super class, and interface</span></div><div class="line">		<span class="comment">// print access flags for this class</span></div><div class="line">		printLog(<span class="string">"\n[ Class Info ]:"</span>);</div><div class="line">		printLog(<span class="string">"This class index = "</span> + this_class_index +<span class="string">", name = "</span></div><div class="line">		        + AnalyzeUtil.getClassName(constPool, this_class_index));</div><div class="line"></div><div class="line">		System.out.print(<span class="string">"  access_flags = "</span> + String.format(<span class="string">"0x%04x"</span>, access_flags));</div><div class="line">		String access_tmp = AnalyzeUtil.analyzeClassAF(access_flags);</div><div class="line">		printLog(<span class="string">" [ "</span> + access_tmp + <span class="string">" ]"</span>);</div><div class="line"></div><div class="line">		printLog(<span class="string">"Super class index = "</span> + super_class_index +<span class="string">", name = "</span></div><div class="line">				+ AnalyzeUtil.getClassName(constPool, super_class_index));</div><div class="line"></div><div class="line">        <span class="comment">// read interfaces count:</span></div><div class="line">		<span class="keyword">short</span> inteCes_count = input.u2();</div><div class="line">		printLog(<span class="string">"\n[ Interface Info ]:"</span>);</div><div class="line">		printLog(<span class="string">"number of interface = "</span> + inteCes_count);</div><div class="line">        <span class="comment">// read each interface:</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= inteCes_count; i++) {</div><div class="line">			<span class="keyword">short</span> inteCe_index = input.u2();</div><div class="line">			printLog(<span class="string">"No. "</span> + i + <span class="string">" interface index = "</span> + inteCe_index + <span class="string">", name = "</span></div><div class="line">					+ AnalyzeUtil.getClassName(constPool, inteCe_index));</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="comment">// read field count:</span></div><div class="line">		<span class="keyword">short</span> field_count = input.u2();</div><div class="line">		printLog(<span class="string">"\n[ Field Info ]:"</span>);</div><div class="line">		printLog(<span class="string">"number of field = "</span> + field_count);</div><div class="line">		<span class="comment">// read each field:</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= field_count; i++) {</div><div class="line">			<span class="keyword">short</span> field_access_flag = input.u2();</div><div class="line">			<span class="keyword">short</span> field_name_index  = input.u2();</div><div class="line">			<span class="keyword">short</span> field_descriptor_index = input.u2();</div><div class="line">			<span class="keyword">short</span> field_attributes_count = input.u2();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">1</span>; j&lt;=field_attributes_count; j++){</div><div class="line">				<span class="keyword">short</span> attribute_name_index = input.u2();</div><div class="line">				<span class="keyword">int</span>   attribute_length = input.u4();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k=<span class="number">1</span>; k&lt;=attribute_length; k++){</div><div class="line">					input.u1(); <span class="comment">// not used attributes</span></div><div class="line">				}</div><div class="line">			}</div><div class="line">			printLog(<span class="string">"No. "</span> + i + <span class="string">" access_flag = "</span></div><div class="line">			        + String.format(<span class="string">"0x%04x"</span>, field_access_flag)+ <span class="string">" name_index = "</span></div><div class="line">					+ field_name_index+ <span class="string">" descriptor_index = "</span></div><div class="line">					+ field_descriptor_index);</div><div class="line">			printLog(<span class="string">"  Original Form: "</span></div><div class="line">					+ AnalyzeUtil.analyzeFieldAF(field_access_flag) + <span class="string">" "</span></div><div class="line">					+ AnalyzeUtil.getFieldString(constPool, field_name_index,</div><div class="line">							field_descriptor_index) + <span class="string">";"</span>);</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="comment">// read method count:</span></div><div class="line">		<span class="keyword">short</span> method_count = input.u2();</div><div class="line">		printLog(<span class="string">"\n[ Method Info ]:"</span>);</div><div class="line">		printLog(<span class="string">"number of method = "</span> + method_count);</div><div class="line">		<span class="comment">// read each method:</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= method_count; i++) {</div><div class="line">			<span class="keyword">short</span> method_access_flag = input.u2();</div><div class="line">			<span class="keyword">short</span> method_name_index  = input.u2();</div><div class="line">			<span class="keyword">short</span> method_descriptor_index = input.u2();</div><div class="line">			<span class="keyword">short</span> method_attributes_count = input.u2();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">1</span>; j&lt;=method_attributes_count; j++){</div><div class="line">				<span class="keyword">short</span> attribute_name_index = input.u2();</div><div class="line">				<span class="keyword">int</span>   attribute_length = input.u4();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k=<span class="number">1</span>; k&lt;=attribute_length; k++){</div><div class="line">					input.u1();  <span class="comment">// not used attributes</span></div><div class="line">				}</div><div class="line">			}</div><div class="line">			printLog(<span class="string">"No. "</span> + i + <span class="string">" access_flag = "</span></div><div class="line">			        + String.format(<span class="string">"0x%04x"</span>, method_access_flag)</div><div class="line">			        + <span class="string">" name_index = "</span></div><div class="line">					+ method_name_index+ <span class="string">" descriptor_index = "</span></div><div class="line">					+ method_descriptor_index);</div><div class="line">			printLog(<span class="string">"  Original Form: "</span></div><div class="line">					+ AnalyzeUtil.analyzeMethodAF(method_access_flag) + <span class="string">" "</span></div><div class="line">					+ AnalyzeUtil.getMethodString(constPool, method_name_index,</div><div class="line">							method_descriptor_index) + <span class="string">";"</span>);</div><div class="line">		}</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>以上代码的<code>main</code>入口读取class文件，并调用<code>analyze</code>来分析。<code>analyze</code>大致分两个步骤，到<code>printConstPool</code>之前，这一段主要是读取常量池的内容，构造常量池对象<code>constPool</code>，有一个小细节是，如果类型是long或者double，那么需要占用2个索引值index，其他情况都是占用1个；之后的部分，是读取类、域、方法的信息，然后从常量池中找到它们的索引值，并输出在屏幕上，输出的时候调用<code>AnalyzeUtil</code>中的方法，以便可以获取易于理解的输出。本例用的是之前的<code>ConstElemU</code>作为测试class，输入如下，</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">[ General Info ]:</div><div class="line">magic <span class="variable">number =</span> <span class="number">0</span>xCAFEBABE</div><div class="line"><span class="variable">Version =</span> <span class="number">50.0</span></div><div class="line">constant pool <span class="variable">size =</span> <span class="number">29</span></div><div class="line"></div><div class="line">[ Constant Pool Info ]:</div><div class="line">constant <span class="variable">index =</span> <span class="number">1</span>, <span class="variable">tag =</span> C_CLASS</div><div class="line"> name at <span class="number">2</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">2</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">29</span> <span class="variable">value =</span> problem1/constelem/ConstElemU</div><div class="line">constant <span class="variable">index =</span> <span class="number">3</span>, <span class="variable">tag =</span> C_CLASS</div><div class="line"> name at <span class="number">4</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">4</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">28</span> <span class="variable">value =</span> problem1/constelem/ConstElem</div><div class="line">constant <span class="variable">index =</span> <span class="number">5</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">4</span> <span class="variable">value =</span> utf8</div><div class="line">constant <span class="variable">index =</span> <span class="number">6</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">18</span> <span class="variable">value =</span> Ljava/lang/String;</div><div class="line">constant <span class="variable">index =</span> <span class="number">7</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">6</span> <span class="variable">value =</span> &lt;init&gt;</div><div class="line">constant <span class="variable">index =</span> <span class="number">8</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">46</span> <span class="variable">value =</span> (Lproblem1/EnumConstType;ILjava/lang/String;)V</div><div class="line">constant <span class="variable">index =</span> <span class="number">9</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">4</span> <span class="variable">value =</span> Code</div><div class="line">constant <span class="variable">index =</span> <span class="number">10</span>, <span class="variable">tag =</span> C_METHODREF</div><div class="line"> <span class="variable">classindex =</span> <span class="number">3</span> <span class="variable">nameandtype =</span> <span class="number">11</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">11</span>, <span class="variable">tag =</span> C_NAMEANDTYPE</div><div class="line"> <span class="variable">nameindex =</span> <span class="number">7</span> <span class="variable">descriptor =</span> <span class="number">12</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">12</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">28</span> <span class="variable">value =</span> (Lproblem1/EnumConstType;I)V</div><div class="line">constant <span class="variable">index =</span> <span class="number">13</span>, <span class="variable">tag =</span> C_FIELDREF</div><div class="line"> <span class="variable">classindex =</span> <span class="number">1</span> <span class="variable">nameandtype =</span> <span class="number">14</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">14</span>, <span class="variable">tag =</span> C_NAMEANDTYPE</div><div class="line"> <span class="variable">nameindex =</span> <span class="number">5</span> <span class="variable">descriptor =</span> <span class="number">6</span></div><div class="line">constant <span class="variable">index =</span> <span class="number">15</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">15</span> <span class="variable">value =</span> LineNumberTable</div><div class="line">constant <span class="variable">index =</span> <span class="number">16</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">18</span> <span class="variable">value =</span> LocalVariableTable</div><div class="line">constant <span class="variable">index =</span> <span class="number">17</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">4</span> <span class="variable">value =</span> this</div><div class="line">constant <span class="variable">index =</span> <span class="number">18</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">31</span> <span class="variable">value =</span> Lproblem1/constelem/ConstElemU;</div><div class="line">constant <span class="variable">index =</span> <span class="number">19</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">3</span> <span class="variable">value =</span> tag</div><div class="line">constant <span class="variable">index =</span> <span class="number">20</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">24</span> <span class="variable">value =</span> Lproblem1/EnumConstType;</div><div class="line">constant <span class="variable">index =</span> <span class="number">21</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">5</span> <span class="variable">value =</span> index</div><div class="line">constant <span class="variable">index =</span> <span class="number">22</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">1</span> <span class="variable">value =</span> I</div><div class="line">constant <span class="variable">index =</span> <span class="number">23</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">7</span> <span class="variable">value =</span> getUtf8</div><div class="line">constant <span class="variable">index =</span> <span class="number">24</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">20</span> <span class="variable">value =</span> ()Ljava/lang/String;</div><div class="line">constant <span class="variable">index =</span> <span class="number">25</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">7</span> <span class="variable">value =</span> setUtf8</div><div class="line">constant <span class="variable">index =</span> <span class="number">26</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">21</span> <span class="variable">value =</span> (Ljava/lang/String;)V</div><div class="line">constant <span class="variable">index =</span> <span class="number">27</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">10</span> <span class="variable">value =</span> SourceFile</div><div class="line">constant <span class="variable">index =</span> <span class="number">28</span>, <span class="variable">tag =</span> C_UTF8</div><div class="line"> <span class="variable">length =</span> <span class="number">15</span> <span class="variable">value =</span> ConstElemU.java</div><div class="line"></div><div class="line">[ Class Info ]:</div><div class="line">This class <span class="variable">index =</span> <span class="number">1</span>, <span class="variable">name =</span> problem1/constelem/ConstElemU</div><div class="line">  <span class="variable">access_flags =</span> <span class="number">0</span>x0021 [ public ]</div><div class="line">Super class <span class="variable">index =</span> <span class="number">3</span>, <span class="variable">name =</span> problem1/constelem/ConstElem</div><div class="line"></div><div class="line">[ Interface Info ]:</div><div class="line">number of <span class="variable">interface =</span> <span class="number">0</span></div><div class="line"></div><div class="line">[ Field Info ]:</div><div class="line">number of <span class="variable">field =</span> <span class="number">1</span></div><div class="line">No. <span class="number">1</span> <span class="variable">access_flag =</span> <span class="number">0</span>x0002 <span class="variable">name_index =</span> <span class="number">5</span> <span class="variable">descriptor_index =</span> <span class="number">6</span></div><div class="line">  Original Form:  private java/lang/String utf8;</div><div class="line"></div><div class="line">[ Method Info ]:</div><div class="line">number of <span class="variable">method =</span> <span class="number">3</span></div><div class="line">No. <span class="number">1</span> <span class="variable">access_flag =</span> <span class="number">0</span>x0001 <span class="variable">name_index =</span> <span class="number">7</span> <span class="variable">descriptor_index =</span> <span class="number">8</span></div><div class="line">  Original Form: public void &lt;init&gt;(problem1/EnumConstType, int, java/lang/String);</div><div class="line">No. <span class="number">2</span> <span class="variable">access_flag =</span> <span class="number">0</span>x0001 <span class="variable">name_index =</span> <span class="number">23</span> <span class="variable">descriptor_index =</span> <span class="number">24</span></div><div class="line">  Original Form: public java/lang/String getUtf8();</div><div class="line">No. <span class="number">3</span> <span class="variable">access_flag =</span> <span class="number">0</span>x0001 <span class="variable">name_index =</span> <span class="number">25</span> <span class="variable">descriptor_index =</span> <span class="number">26</span></div><div class="line">  Original Form: public void setUtf8(java/lang/String);</div></pre></td></tr></table></figure></p>
<p><img src="/images/201410-java-class-file/class-file-test.png"></p>
<p>输出的内容很多，前一段是输出整个常量池的内容，如果不看这部分，剩下的内容从<code>[ Class Info ]:</code>开始，就很少了。<code>[ Class Info ]:</code>部分，可以得知，class文件的类是<code>problem1/constelem/ConstElemU</code>，是<code>public</code>的，其超类是<code>problem1/constelem/ConstElem</code>；<code>[ Interface Info ]:</code>部分没有内容，因为该类没有实现接口；<code>[ Field Info ]:</code>部分，有1个域，可以写成<code>private java/lang/String utf8</code>，也就是<code>private String utf8</code>；<code>[ Method Info ]:</code>有3个方法，第1个是构造方法<code>public void &lt;init&gt;(problem1/EnumConstType, int, java/lang/String)</code>，构造方法的名称统一写成了<code>&lt;init&gt;</code>，需要替换为类名，并加了<code>void</code>返回值，实际不需要，略微改写为<code>public ConstElemU(EnumConstType, int, String)</code>，另外2个方法<code>public java/lang/String getUtf8()</code>和<code>public void setUtf8(java/lang/String)</code>，可以改写为<code>public String getUtf8()</code>和<code>public void setUtf8(String)</code>。对比原本的代码可以发现，以上输出，基本还原了<code>ConstElemU</code>的类定义。</p>
<p>本例的代码还可以进一步修改来支持float和double类型常数，代码参考了<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a>。</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="http://blog.csdn.net/oracle_microsoft/article/details/4417075" target="_blank" rel="external">http://blog.csdn.net/oracle_microsoft/article/details/4417075</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p><a href="http://developer.51cto.com/art/201203/321576.htm" target="_blank" rel="external">http://developer.51cto.com/art/201203/321576.htm</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p><a href="http://xmuzyq.iteye.com/blog/1779334" target="_blank" rel="external">http://xmuzyq.iteye.com/blog/1779334</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p><a href="http://wenku.baidu.com/link?url=f2ahIgyDjm4lu5BWuklxfTvErlwMe__AVPGckl4wXUebN6Q-Reco9PnjF-xODvDrGggNnG1dNJDjEonE5ujq2xRlt6ezcCs3wRi2NuchDYW" target="_blank" rel="external">http://wenku.baidu.com/link?url=f2ahIgyDjm4lu5BWuklxfTvErlwMe__AVPGckl4wXUebN6Q-Reco9PnjF-xODvDrGggNnG1dNJDjEonE5ujq2xRlt6ezcCs3wRi2NuchDYW</a><a href="#fnref4">↩</a></p></li>
</ol>
</div>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/JVM/">JVM</a><a href="/tags/Java/">Java</a><a href="/tags/Dataguru/">Dataguru</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JVM/">JVM</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://valleylord.github.io/post/201410-java-class-file/" data-title="Java class文件解析代码分析 | 褚哥说|" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/post/201410-java-asm-lib/" title="使用ASM框架生成Java class文件">
  <strong>PREVIOUS:</strong><br/>
  <span>
  使用ASM框架生成Java class文件</span>
</a>
</div>


<div class="next">
<a href="/post/201410-postgres-uuid/"  title="PostgreSQL添加UUID扩展">
 <strong>NEXT:</strong><br/> 
 <span>PostgreSQL添加UUID扩展
</span>
</a>
</div>

</nav>

	
</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 欢迎来到Valleylord的博客！</p>
		
		
			<p>	本博的文章尽量原创。</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/http://weibo.com/valleylord" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/https://github.com/valleylord" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2000/01/">January 2000</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Blog/" title="Blog">Blog<sup>1</sup></a></li>
		
			<li><a href="/categories/Bug/" title="Bug">Bug<sup>1</sup></a></li>
		
			<li><a href="/categories/C/" title="C++">C++<sup>3</sup></a></li>
		
			<li><a href="/categories/Dataguru/" title="Dataguru">Dataguru<sup>3</sup></a></li>
		
			<li><a href="/categories/Docker/" title="Docker">Docker<sup>7</sup></a></li>
		
			<li><a href="/categories/FP/" title="FP">FP<sup>2</sup></a></li>
		
			<li><a href="/categories/JVM/" title="JVM">JVM<sup>10</sup></a></li>
		
			<li><a href="/categories/Java/" title="Java">Java<sup>1</sup></a></li>
		
			<li><a href="/categories/Kubernetes/" title="Kubernetes">Kubernetes<sup>7</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/categories/MyCAT/" title="MyCAT">MyCAT<sup>14</sup></a></li>
		
			<li><a href="/categories/Postgres/" title="Postgres">Postgres<sup>18</sup></a></li>
		
			<li><a href="/categories/REPL/" title="REPL">REPL<sup>1</sup></a></li>
		
			<li><a href="/categories/SSL/" title="SSL">SSL<sup>1</sup></a></li>
		
			<li><a href="/categories/Spring-Boot/" title="Spring Boot">Spring Boot<sup>1</sup></a></li>
		
			<li><a href="/categories/Tomcat/" title="Tomcat">Tomcat<sup>0</sup></a></li>
		
			<li><a href="/categories/other/" title="other">other<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Blog/" title="Blog">Blog<sup>1</sup></a></li>
		
			<li><a href="/tags/Bug/" title="Bug">Bug<sup>1</sup></a></li>
		
			<li><a href="/tags/C/" title="C++">C++<sup>3</sup></a></li>
		
			<li><a href="/tags/C-11/" title="C++11">C++11<sup>1</sup></a></li>
		
			<li><a href="/tags/Dataguru/" title="Dataguru">Dataguru<sup>60</sup></a></li>
		
			<li><a href="/tags/Docker/" title="Docker">Docker<sup>7</sup></a></li>
		
			<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/JVM/" title="JVM">JVM<sup>10</sup></a></li>
		
			<li><a href="/tags/Java/" title="Java">Java<sup>12</sup></a></li>
		
			<li><a href="/tags/Kubernetes/" title="Kubernetes">Kubernetes<sup>7</sup></a></li>
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/MyCAT/" title="MyCAT">MyCAT<sup>14</sup></a></li>
		
			<li><a href="/tags/Postgres/" title="Postgres">Postgres<sup>18</sup></a></li>
		
			<li><a href="/tags/Quantmod/" title="Quantmod">Quantmod<sup>3</sup></a></li>
		
			<li><a href="/tags/R/" title="R">R<sup>3</sup></a></li>
		
			<li><a href="/tags/REPL/" title="REPL">REPL<sup>1</sup></a></li>
		
			<li><a href="/tags/SICP/" title="SICP">SICP<sup>2</sup></a></li>
		
			<li><a href="/tags/SSL/" title="SSL">SSL<sup>1</sup></a></li>
		
			<li><a href="/tags/Spring-Boot/" title="Spring Boot">Spring Boot<sup>1</sup></a></li>
		
			<li><a href="/tags/Tomcat/" title="Tomcat">Tomcat<sup>2</sup></a></li>
		
		</ul>
</div>


  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/Blog/" style="font-size: 10.00px;">Blog</a><a href="/tags/Bug/" style="font-size: 10.00px;">Bug</a><a href="/tags/C/" style="font-size: 12.50px;">C++</a><a href="/tags/C-11/" style="font-size: 10.00px;">C++11</a><a href="/tags/Dataguru/" style="font-size: 20.00px;">Dataguru</a><a href="/tags/Docker/" style="font-size: 13.75px;">Docker</a><a href="/tags/Hexo/" style="font-size: 10.00px;">Hexo</a><a href="/tags/JVM/" style="font-size: 15.00px;">JVM</a><a href="/tags/Java/" style="font-size: 16.25px;">Java</a><a href="/tags/Kubernetes/" style="font-size: 13.75px;">Kubernetes</a><a href="/tags/Linux/" style="font-size: 10.00px;">Linux</a><a href="/tags/MyCAT/" style="font-size: 17.50px;">MyCAT</a><a href="/tags/Postgres/" style="font-size: 18.75px;">Postgres</a><a href="/tags/Quantmod/" style="font-size: 12.50px;">Quantmod</a><a href="/tags/R/" style="font-size: 12.50px;">R</a><a href="/tags/REPL/" style="font-size: 10.00px;">REPL</a><a href="/tags/SICP/" style="font-size: 11.25px;">SICP</a><a href="/tags/SSL/" style="font-size: 10.00px;">SSL</a><a href="/tags/Spring-Boot/" style="font-size: 10.00px;">Spring Boot</a><a href="/tags/Tomcat/" style="font-size: 11.25px;">Tomcat</a><a href="/tags/Translation/" style="font-size: 11.25px;">Translation</a><a href="/tags/boost/" style="font-size: 10.00px;">boost</a><a href="/tags/quantlib/" style="font-size: 10.00px;">quantlib</a><a href="/tags/scheme/" style="font-size: 11.25px;">scheme</a><a href="/tags/shipyard/" style="font-size: 10.00px;">shipyard</a><a href="/tags/转载/" style="font-size: 11.25px;">转载</a>
    </div>
  </div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <!--
      <li><a href="http://yangjian.me" target="_blank" title="YangJian">Alimon's Blog</a></li>
      <li><a href="http://zespia.tw/hexo" target="_blank" title="Hexo">Hexo</a></li>
      -->
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
